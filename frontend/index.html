<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Set Decoder - Identify DJ Set Tracks</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      @import url('https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&display=swap');

      body {
        font-family: 'Space Grotesk', sans-serif;
        overflow-x: hidden;
      }

      .gradient-bg {
        background: linear-gradient(
          135deg,
          #0a0a0f 0%,
          #1a0a2e 50%,
          #0f0a1a 100%
        );
        min-height: 100vh;
        position: relative;
      }

      .wave-bg {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        opacity: 0.3;
        z-index: 0;
      }

      .wave {
        position: absolute;
        width: 200%;
        height: 200%;
        background: radial-gradient(
          ellipse at center,
          rgba(139, 92, 246, 0.15) 0%,
          transparent 70%
        );
        animation: wave-float 8s ease-in-out infinite;
      }

      .wave:nth-child(2) {
        animation-delay: -2s;
        background: radial-gradient(
          ellipse at center,
          rgba(236, 72, 153, 0.1) 0%,
          transparent 70%
        );
      }

      .wave:nth-child(3) {
        animation-delay: -4s;
        background: radial-gradient(
          ellipse at center,
          rgba(59, 130, 246, 0.1) 0%,
          transparent 70%
        );
      }

      @keyframes wave-float {
        0%,
        100% {
          transform: translate(-25%, -25%) rotate(0deg);
        }
        50% {
          transform: translate(-25%, -25%) rotate(180deg);
        }
      }

      .visualizer {
        display: flex;
        align-items: flex-end;
        justify-content: center;
        gap: 3px;
        height: 40px;
        margin-bottom: 1rem;
      }

      .bar {
        width: 4px;
        background: linear-gradient(to top, #8b5cf6, #ec4899);
        border-radius: 2px;
        animation: bar-dance 0.5s ease-in-out infinite alternate;
      }

      .bar:nth-child(1) {
        height: 40%;
        animation-delay: 0s;
      }
      .bar:nth-child(2) {
        height: 70%;
        animation-delay: 0.1s;
      }
      .bar:nth-child(3) {
        height: 50%;
        animation-delay: 0.2s;
      }
      .bar:nth-child(4) {
        height: 90%;
        animation-delay: 0.3s;
      }
      .bar:nth-child(5) {
        height: 60%;
        animation-delay: 0.4s;
      }
      .bar:nth-child(6) {
        height: 80%;
        animation-delay: 0.5s;
      }
      .bar:nth-child(7) {
        height: 45%;
        animation-delay: 0.6s;
      }
      .bar:nth-child(8) {
        height: 75%;
        animation-delay: 0.7s;
      }
      .bar:nth-child(9) {
        height: 55%;
        animation-delay: 0.8s;
      }

      @keyframes bar-dance {
        0% {
          transform: scaleY(0.5);
        }
        100% {
          transform: scaleY(1);
        }
      }

      .glass {
        background: rgba(255, 255, 255, 0.03);
        backdrop-filter: blur(20px);
        border: 1px solid rgba(255, 255, 255, 0.08);
      }

      .glass-strong {
        background: rgba(139, 92, 246, 0.05);
        backdrop-filter: blur(20px);
        border: 1px solid rgba(139, 92, 246, 0.2);
      }

      .neon-text {
        text-shadow:
          0 0 20px rgba(139, 92, 246, 0.8),
          0 0 40px rgba(139, 92, 246, 0.4);
      }

      .neon-border {
        box-shadow:
          0 0 20px rgba(139, 92, 246, 0.3),
          inset 0 0 20px rgba(139, 92, 246, 0.1);
      }

      .track-card {
        transition: all 0.3s ease;
      }

      .track-card:hover {
        transform: translateX(8px);
        background: rgba(139, 92, 246, 0.1);
        border-color: rgba(139, 92, 246, 0.3);
      }

      .pulse-dot {
        animation: pulse-glow 2s infinite;
      }

      @keyframes pulse-glow {
        0%,
        100% {
          opacity: 1;
          box-shadow: 0 0 10px rgba(34, 197, 94, 0.8);
        }
        50% {
          opacity: 0.5;
          box-shadow: 0 0 20px rgba(34, 197, 94, 0.4);
        }
      }

      .btn-primary {
        background: linear-gradient(135deg, #8b5cf6 0%, #ec4899 100%);
        transition: all 0.3s ease;
      }

      .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 30px rgba(139, 92, 246, 0.4);
      }

      .progress-bar {
        background: linear-gradient(
          90deg,
          #8b5cf6 0%,
          #ec4899 50%,
          #8b5cf6 100%
        );
        background-size: 200% 100%;
        animation: progress-shimmer 2s linear infinite;
      }

      @keyframes progress-shimmer {
        0% {
          background-position: -200% 0;
        }
        100% {
          background-position: 200% 0;
        }
      }

      .platform-icon {
        transition: all 0.2s ease;
      }

      .platform-icon:hover {
        transform: scale(1.2);
      }

      .spotify-icon:hover {
        filter: drop-shadow(0 0 8px #1db954);
      }
      .apple-icon:hover {
        filter: drop-shadow(0 0 8px #fc3c44);
      }
      .deezer-icon:hover {
        filter: drop-shadow(0 0 8px #ff0092);
      }

      input:focus,
      select:focus {
        border-color: rgba(139, 92, 246, 0.5);
        box-shadow: 0 0 20px rgba(139, 92, 246, 0.2);
      }

      ::-webkit-scrollbar {
        width: 8px;
      }
      ::-webkit-scrollbar-track {
        background: rgba(0, 0, 0, 0.2);
      }
      ::-webkit-scrollbar-thumb {
        background: linear-gradient(180deg, #8b5cf6, #ec4899);
        border-radius: 4px;
      }
    </style>
  </head>
  <body class="gradient-bg text-white">
    <!-- Animated Background -->
    <div class="wave-bg">
      <div class="wave"></div>
      <div class="wave"></div>
      <div class="wave"></div>
    </div>

    <div id="app" class="container mx-auto px-4 py-12 max-w-4xl relative z-10">
      <!-- Header -->
      <div class="text-center mb-16">
        <div class="visualizer">
          <div class="bar"></div>
          <div class="bar"></div>
          <div class="bar"></div>
          <div class="bar"></div>
          <div class="bar"></div>
          <div class="bar"></div>
          <div class="bar"></div>
          <div class="bar"></div>
          <div class="bar"></div>
        </div>
        <h1
          class="text-6xl font-bold mb-4 neon-text bg-gradient-to-r from-purple-400 via-pink-400 to-purple-400 bg-clip-text text-transparent"
        >
          Set Decoder
        </h1>
        <p class="text-gray-400 text-lg tracking-wide">
          Identify every track in a DJ set automatically
        </p>
      </div>

      <!-- Input Section -->
      <div class="glass-strong rounded-3xl p-8 mb-8 neon-border">
        <div class="flex flex-col md:flex-row gap-4">
          <input
            type="text"
            id="urlInput"
            oninput="handleUrlInput(this.value)"
            placeholder="Paste YouTube or SoundCloud URL..."
            class="flex-1 bg-black/40 border border-white/10 rounded-2xl px-6 py-4 text-white placeholder-gray-500 focus:outline-none transition text-lg"
          />
          <button
            id="identifyBtn"
            onclick="startIdentification()"
            class="btn-primary px-10 py-4 rounded-2xl font-semibold flex items-center justify-center gap-3 text-lg"
          >
            <svg
              class="w-5 h-5"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"
              />
            </svg>
            <span>Decode Set</span>
          </button>
        </div>

        <!-- Video Preview -->
        <div id="videoPreview" class="hidden mt-6">
          <div
            class="flex gap-4 items-center bg-black/30 rounded-2xl p-4 border border-white/5"
          >
            <div class="relative flex-shrink-0">
              <img
                id="previewThumbnail"
                src=""
                alt="Video thumbnail"
                class="w-40 h-24 object-cover rounded-xl"
              />
              <div class="absolute inset-0 flex items-center justify-center">
                <div
                  class="w-10 h-10 bg-red-600 rounded-full flex items-center justify-center"
                >
                  <svg
                    class="w-5 h-5 text-white ml-0.5"
                    fill="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path d="M8 5v14l11-7z" />
                  </svg>
                </div>
              </div>
            </div>
            <div class="flex-1 min-w-0">
              <div id="previewTitle" class="font-semibold text-white truncate">
                Video Title
              </div>
              <div id="previewChannel" class="text-sm text-gray-400 truncate">
                Channel Name
              </div>
              <div id="previewDuration" class="text-xs text-purple-400 mt-1">
                Duration: --:--
              </div>
            </div>
            <button
              onclick="clearPreview()"
              class="p-2 hover:bg-white/10 rounded-xl transition"
            >
              <svg
                class="w-5 h-5 text-gray-400"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M6 18L18 6M6 6l12 12"
                />
              </svg>
            </button>
          </div>
        </div>

        <!-- Options -->
        <div class="mt-6 flex items-center gap-4 text-sm text-gray-400">
          <label class="flex items-center gap-3">
            <span>Sample interval:</span>
            <select
              id="segmentDuration"
              class="bg-black/40 border border-white/10 rounded-xl px-4 py-2 focus:outline-none transition"
            >
              <option value="20">20 sec</option>
              <option value="30" selected>30 sec</option>
              <option value="45">45 sec</option>
              <option value="60">60 sec</option>
            </select>
          </label>
          <span class="text-gray-600">‚Ä¢</span>
          <span class="text-gray-500"
            >Shorter intervals = more accurate detection</span
          >
        </div>
      </div>

      <!-- Status Section -->
      <div id="statusSection" class="hidden glass rounded-3xl p-8 mb-8">
        <div class="flex items-center gap-4">
          <div class="pulse-dot w-3 h-3 bg-green-500 rounded-full"></div>
          <div class="flex-1">
            <div id="statusText" class="font-medium text-lg">Processing...</div>
            <div id="setInfo" class="text-sm text-gray-400 mt-1"></div>
          </div>
        </div>

        <!-- Progress Bar -->
        <div class="mt-6">
          <div class="h-2 bg-black/40 rounded-full overflow-hidden">
            <div
              id="progressBar"
              class="progress-bar h-full transition-all duration-500"
              style="width: 0%"
            ></div>
          </div>
          <div id="progressText" class="text-sm text-gray-400 mt-3"></div>
        </div>
      </div>

      <!-- Results Section -->
      <div id="resultsSection" class="hidden">
        <div class="flex items-center justify-between mb-8">
          <h2
            class="text-3xl font-bold bg-gradient-to-r from-purple-400 to-pink-400 bg-clip-text text-transparent"
          >
            Tracklist
          </h2>
          <div class="flex gap-3">
            <button
              onclick="copyTracklist()"
              class="glass px-5 py-2.5 rounded-xl text-sm hover:bg-white/10 transition flex items-center gap-2"
            >
              <svg
                class="w-4 h-4"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"
                />
              </svg>
              Copy
            </button>
            <button
              onclick="exportJSON()"
              class="glass px-5 py-2.5 rounded-xl text-sm hover:bg-white/10 transition flex items-center gap-2"
            >
              <svg
                class="w-4 h-4"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"
                />
              </svg>
              Export
            </button>
          </div>
        </div>

        <div id="tracksList" class="space-y-3">
          <!-- Tracks will be inserted here -->
        </div>

        <!-- Stats -->
        <div id="statsSection" class="glass rounded-3xl p-8 mt-10">
          <h3 class="font-semibold mb-6 text-gray-300">Statistics</h3>
          <div class="grid grid-cols-3 gap-6 text-center">
            <div class="glass rounded-2xl p-6">
              <div
                id="totalTracks"
                class="text-4xl font-bold bg-gradient-to-r from-purple-400 to-pink-400 bg-clip-text text-transparent"
              >
                0
              </div>
              <div class="text-sm text-gray-400 mt-2">Total Segments</div>
            </div>
            <div class="glass rounded-2xl p-6">
              <div
                id="identifiedTracks"
                class="text-4xl font-bold text-green-400"
              >
                0
              </div>
              <div class="text-sm text-gray-400 mt-2">Identified</div>
            </div>
            <div class="glass rounded-2xl p-6">
              <div
                id="notFoundTracks"
                class="text-4xl font-bold text-yellow-400"
              >
                0
              </div>
              <div class="text-sm text-gray-400 mt-2">Unreleased/ID</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Footer -->
      <div class="text-center mt-16 text-gray-600 text-sm">
        <p>Powered by AudD API ‚Ä¢ Built for DJs and music lovers</p>
      </div>
    </div>

    <script>
      const API_URL = 'http://localhost:8000'
      let currentJobId = null
      let pollInterval = null
      let allTracks = []

      // Platform Icons SVG
      const spotifyIcon = `<svg class="w-6 h-6 platform-icon spotify-icon" viewBox="0 0 24 24" fill="#1DB954">
            <path d="M12 0C5.4 0 0 5.4 0 12s5.4 12 12 12 12-5.4 12-12S18.66 0 12 0zm5.521 17.34c-.24.359-.66.48-1.021.24-2.82-1.74-6.36-2.101-10.561-1.141-.418.122-.779-.179-.899-.539-.12-.421.18-.78.54-.9 4.56-1.021 8.52-.6 11.64 1.32.42.18.479.659.301 1.02zm1.44-3.3c-.301.42-.841.6-1.262.3-3.239-1.98-8.159-2.58-11.939-1.38-.479.12-1.02-.12-1.14-.6-.12-.48.12-1.021.6-1.141C9.6 9.9 15 10.561 18.72 12.84c.361.181.54.78.241 1.2zm.12-3.36C15.24 8.4 8.82 8.16 5.16 9.301c-.6.179-1.2-.181-1.38-.721-.18-.601.18-1.2.72-1.381 4.26-1.26 11.28-1.02 15.721 1.621.539.3.719 1.02.419 1.56-.299.421-1.02.599-1.559.3z"/>
        </svg>`

      const appleIcon = `<svg class="w-6 h-6 platform-icon apple-icon" viewBox="0 0 24 24" fill="#fc3c44">
            <path d="M23.994 6.124a9.23 9.23 0 00-.24-2.19c-.317-1.31-1.062-2.31-2.18-3.043a5.022 5.022 0 00-1.877-.726 10.496 10.496 0 00-1.564-.15c-.04-.003-.083-.01-.124-.013H5.986c-.152.01-.303.017-.455.026-.747.043-1.49.123-2.193.4-1.336.53-2.3 1.452-2.865 2.78-.192.448-.292.925-.363 1.408-.056.392-.088.785-.1 1.18 0 .032-.007.062-.01.093v12.223c.01.14.017.283.027.424.05.815.154 1.624.497 2.373.65 1.42 1.738 2.353 3.234 2.801.42.127.856.187 1.293.228.555.053 1.11.06 1.667.06h11.03a12.5 12.5 0 001.57-.1c.822-.106 1.596-.35 2.295-.81a5.046 5.046 0 001.88-2.207c.186-.42.293-.87.37-1.324.113-.675.138-1.358.137-2.04-.002-3.8 0-7.595-.003-11.393zm-6.423 3.99v5.712c0 .417-.058.827-.244 1.206-.29.59-.76.962-1.388 1.14-.35.1-.706.157-1.07.173-.95.042-1.785-.282-2.442-.966-.436-.454-.66-.996-.615-1.627.047-.66.357-1.18.856-1.587.482-.393 1.05-.586 1.658-.675.45-.066.904-.1 1.356-.15.245-.027.474-.085.64-.3.107-.138.16-.303.16-.477V8.08c0-.094-.013-.18-.08-.26-.037-.037-.09-.04-.138-.052-.08-.02-.162-.03-.243-.035-.25-.017-.5-.023-.75-.04-.622-.036-1.244-.073-1.865-.12-.734-.057-1.467-.132-2.195-.233-.803-.112-1.598-.26-2.365-.525-.15-.05-.295-.117-.444-.178V16.44c0 .386-.048.766-.213 1.12-.295.635-.79 1.04-1.453 1.23a3.4 3.4 0 01-.99.153c-.96.024-1.78-.283-2.43-.98-.492-.524-.723-1.17-.644-1.9.084-.74.45-1.313 1.048-1.727.44-.305.93-.464 1.452-.554.59-.102 1.188-.152 1.783-.205.128-.01.258-.025.384-.048.17-.03.318-.098.418-.25.076-.115.108-.248.108-.388V5.734c0-.24.055-.47.192-.67.152-.224.368-.353.62-.4.14-.027.28-.037.42-.043.862-.036 1.723-.06 2.586-.07.9-.013 1.8 0 2.7.05.723.04 1.445.1 2.163.18.623.07 1.24.175 1.838.36.164.05.328.106.483.18.34.163.53.426.53.81z"/>
        </svg>`

      const deezerIcon = `<svg class="w-6 h-6 platform-icon deezer-icon" viewBox="0 0 24 24" fill="#FF0092">
            <path d="M18.81 4.16v3.03H24V4.16h-5.19zM6.27 8.38v3.027h5.189V8.38h-5.19zm12.54 0v3.027H24V8.38h-5.19zM6.27 12.594v3.027h5.189v-3.027h-5.19zm6.27 0v3.027h5.19v-3.027h-5.19zm6.27 0v3.027H24v-3.027h-5.19zM0 16.81v3.029h5.19v-3.03H0zm6.27 0v3.029h5.189v-3.03h-5.19zm6.27 0v3.029h5.19v-3.03h-5.19zm6.27 0v3.029H24v-3.03h-5.19z"/>
        </svg>`

      // Video Preview Functions
      function extractYoutubeId(url) {
        const patterns = [
          /(?:youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/embed\/)([^&\n?#]+)/,
          /youtube\.com\/shorts\/([^&\n?#]+)/,
        ]
        for (const pattern of patterns) {
          const match = url.match(pattern)
          if (match) return match[1]
        }
        return null
      }

      function extractSoundcloudUrl(url) {
        if (url.includes('soundcloud.com')) {
          return url
        }
        return null
      }

      async function handleUrlInput(url) {
        const preview = document.getElementById('videoPreview')

        if (!url.trim()) {
          preview.classList.add('hidden')
          return
        }

        const youtubeId = extractYoutubeId(url)
        if (youtubeId) {
          showYoutubePreview(youtubeId)
          return
        }

        const soundcloudUrl = extractSoundcloudUrl(url)
        if (soundcloudUrl) {
          showSoundcloudPreview(soundcloudUrl)
          return
        }

        preview.classList.add('hidden')
      }

      async function showYoutubePreview(videoId) {
        const preview = document.getElementById('videoPreview')
        const thumbnail = document.getElementById('previewThumbnail')
        const title = document.getElementById('previewTitle')
        const channel = document.getElementById('previewChannel')
        const duration = document.getElementById('previewDuration')

        thumbnail.src = `https://img.youtube.com/vi/${videoId}/mqdefault.jpg`
        preview.classList.remove('hidden')

        try {
          const response = await fetch(
            `https://noembed.com/embed?url=https://www.youtube.com/watch?v=${videoId}`,
          )
          const data = await response.json()

          if (data.title) {
            title.textContent = data.title
            channel.textContent = data.author_name || 'YouTube'
            duration.textContent = 'Ready to decode'
          }
        } catch (error) {
          title.textContent = 'YouTube Video'
          channel.textContent = 'Click Decode to start'
          duration.textContent = ''
        }
      }

      function showSoundcloudPreview(url) {
        const preview = document.getElementById('videoPreview')
        const thumbnail = document.getElementById('previewThumbnail')
        const title = document.getElementById('previewTitle')
        const channel = document.getElementById('previewChannel')
        const duration = document.getElementById('previewDuration')

        thumbnail.src =
          'data:image/svg+xml,' +
          encodeURIComponent(`
                <svg xmlns="http://www.w3.org/2000/svg" width="160" height="96" viewBox="0 0 160 96">
                    <defs>
                        <linearGradient id="sc" x1="0%" y1="0%" x2="100%" y2="100%">
                            <stop offset="0%" style="stop-color:#ff8800"/>
                            <stop offset="100%" style="stop-color:#ff5500"/>
                        </linearGradient>
                    </defs>
                    <rect fill="url(#sc)" width="160" height="96"/>
                    <text x="80" y="55" text-anchor="middle" fill="white" font-family="Arial" font-size="14" font-weight="bold">SoundCloud</text>
                </svg>
            `)

        title.textContent = 'SoundCloud Track'
        channel.textContent = url.split('/')[3] || 'SoundCloud'
        duration.textContent = 'Ready to decode'
        preview.classList.remove('hidden')
      }

      function clearPreview() {
        document.getElementById('urlInput').value = ''
        document.getElementById('videoPreview').classList.add('hidden')
      }

      async function startIdentification() {
        const url = document.getElementById('urlInput').value.trim()
        const segmentDuration = parseInt(
          document.getElementById('segmentDuration').value,
        )

        if (!url) {
          alert('Please paste a YouTube or SoundCloud URL')
          return
        }

        document.getElementById('statusSection').classList.remove('hidden')
        document.getElementById('resultsSection').classList.add('hidden')
        document.getElementById('identifyBtn').disabled = true
        document.getElementById('identifyBtn').innerHTML =
          '<svg class="animate-spin h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Decoding...'
        document.getElementById('tracksList').innerHTML = ''
        allTracks = []

        try {
          const response = await fetch(`${API_URL}/api/identify`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ url, segment_duration: segmentDuration }),
          })

          const data = await response.json()
          currentJobId = data.job_id
          pollInterval = setInterval(pollStatus, 2000)
        } catch (error) {
          alert('Error connecting to server. Make sure the backend is running.')
          resetUI()
        }
      }

      async function pollStatus() {
        if (!currentJobId) return

        try {
          const response = await fetch(`${API_URL}/api/status/${currentJobId}`)
          const data = await response.json()

          updateStatus(data)

          if (data.status === 'completed' || data.status === 'error') {
            clearInterval(pollInterval)
            resetUI()

            if (data.status === 'completed') {
              showResults(data)
            }
          }
        } catch (error) {
          console.error('Polling error:', error)
        }
      }

      function updateStatus(data) {
        document.getElementById('statusText').textContent = data.message

        if (data.set_info) {
          document.getElementById('setInfo').textContent =
            `${data.set_info.title} ‚Ä¢ ${formatDuration(data.set_info.duration)}`
        }

        if (data.total_duration > 0) {
          const progress = (data.current_position / data.total_duration) * 100
          document.getElementById('progressBar').style.width = `${progress}%`
          document.getElementById('progressText').textContent =
            `${formatDuration(data.current_position)} / ${formatDuration(data.total_duration)}`
        }

        if (data.tracks && data.tracks.length > allTracks.length) {
          allTracks = data.tracks
          document.getElementById('resultsSection').classList.remove('hidden')
          renderTracks(data.tracks)
          updateStats(data.tracks)
        }
      }

      function showResults(data) {
        document.getElementById('resultsSection').classList.remove('hidden')
        renderTracks(data.tracks)
        updateStats(data.tracks)
      }

      function renderTracks(tracks) {
        const container = document.getElementById('tracksList')
        container.innerHTML = tracks
          .map((track, index) => {
            if (track.status === 'not_found') {
              return `
                        <div class="track-card glass rounded-2xl p-5 transition border border-transparent">
                            <div class="flex items-center gap-5">
                                <div class="text-purple-400 font-mono text-sm w-20 flex-shrink-0">${track.timestamp}</div>
                                <div class="w-12 h-12 rounded-xl bg-yellow-500/20 flex items-center justify-center flex-shrink-0">
                                    <span class="text-xl">‚ùì</span>
                                </div>
                                <div class="flex-1 min-w-0">
                                    <div class="text-yellow-400 font-medium">Unreleased / ID</div>
                                    <div class="text-sm text-gray-500">Track not found in database</div>
                                </div>
                            </div>
                        </div>
                    `
            }

            return `
                    <div class="track-card glass rounded-2xl p-5 transition border border-transparent">
                        <div class="flex items-center gap-5">
                            <div class="text-purple-400 font-mono text-sm w-20 flex-shrink-0">${track.timestamp}</div>
                            <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-purple-500/30 to-pink-500/30 flex items-center justify-center flex-shrink-0">
                                <span class="text-xl">üéµ</span>
                            </div>
                            <div class="flex-1 min-w-0">
                                <div class="font-semibold text-white truncate">${track.title || 'Unknown'}</div>
                                <div class="text-sm text-gray-400 truncate">${track.artist || 'Unknown Artist'}</div>
                            </div>
                            <div class="flex gap-3 flex-shrink-0">
                                ${track.spotify_url ? `<a href="${track.spotify_url}" target="_blank" title="Open in Spotify">${spotifyIcon}</a>` : ''}
                                ${track.apple_music_url ? `<a href="${track.apple_music_url}" target="_blank" title="Open in Apple Music">${appleIcon}</a>` : ''}
                                ${track.deezer_url ? `<a href="${track.deezer_url}" target="_blank" title="Open in Deezer">${deezerIcon}</a>` : ''}
                            </div>
                        </div>
                    </div>
                `
          })
          .join('')
      }

      function updateStats(tracks) {
        const identified = tracks.filter(
          (t) => t.status === 'identified',
        ).length
        const notFound = tracks.filter((t) => t.status === 'not_found').length

        document.getElementById('totalTracks').textContent = tracks.length
        document.getElementById('identifiedTracks').textContent = identified
        document.getElementById('notFoundTracks').textContent = notFound
      }

      function formatDuration(seconds) {
        const hours = Math.floor(seconds / 3600)
        const minutes = Math.floor((seconds % 3600) / 60)
        const secs = seconds % 60

        if (hours > 0) {
          return `${hours}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`
        }
        return `${minutes}:${secs.toString().padStart(2, '0')}`
      }

      function resetUI() {
        document.getElementById('identifyBtn').disabled = false
        document.getElementById('identifyBtn').innerHTML = `
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                </svg>
                <span>Decode Set</span>
            `
      }

      function copyTracklist() {
        const text = allTracks
          .filter((t) => t.status === 'identified')
          .map((t) => `${t.timestamp} - ${t.artist} - ${t.title}`)
          .join('\n')

        navigator.clipboard.writeText(text)

        const btn = event.target.closest('button')
        const originalText = btn.innerHTML
        btn.innerHTML =
          '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg> Copied!'
        setTimeout(() => {
          btn.innerHTML = originalText
        }, 2000)
      }

      function exportJSON() {
        const blob = new Blob([JSON.stringify(allTracks, null, 2)], {
          type: 'application/json',
        })
        const url = URL.createObjectURL(blob)
        const a = document.createElement('a')
        a.href = url
        a.download = 'tracklist.json'
        a.click()
      }
    </script>
  </body>
</html>
